version: "3.9"

# Timbot - Twitch/Discord Integration Bot
# A Discord bot that integrates with Twitch for clips, live alerts, and voice channel management
#
# Deployed via homelab-apps manifest
# Secrets: DISCORD_BOT_TOKEN, TWITCH_CLIENT_ID, TWITCH_CLIENT_SECRET (all required)
# Infisical path: /services/timbot/
# Docs: See README.md

services:
  timbot:
    image: harbor.dev.thebozic.com/timbot/timbot:1.0.1
    container_name: timbot
    user: "3002:3002"  # Run as docker-svc user
    environment:
      # Discord configuration
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_GUILD_ID=${DISCORD_GUILD_ID}
      - COMMAND_PREFIX=${COMMAND_PREFIX:-!}
      
      # Discord channel IDs
      - CLIPS_CHANNEL_ID=${CLIPS_CHANNEL_ID}
      - LIVE_ALERTS_CHANNEL_ID=${LIVE_ALERTS_CHANNEL_ID}
      - VOICE_CATEGORY_ID=${VOICE_CATEGORY_ID}
      
      # Twitch configuration (from Infisical: /services/timbot/)
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
      - TWITCH_OWNER_CHANNELS=${TWITCH_OWNER_CHANNELS}
      
      # Role configuration
      - STREAMER_ROLE_ID=${STREAMER_ROLE_ID}
      
      # Polling intervals (seconds)
      - CLIP_CHECK_INTERVAL=${CLIP_CHECK_INTERVAL:-300}
      - LIVE_CHECK_INTERVAL=${LIVE_CHECK_INTERVAL:-60}
      - VOICE_CHECK_INTERVAL=${VOICE_CHECK_INTERVAL:-10}
      
      # Voice channel settings
      - VOICE_CHANNEL_PREFIX=${VOICE_CHANNEL_PREFIX:-ðŸŽ® Gaming}
      - MAX_VOICE_CHANNELS=${MAX_VOICE_CHANNELS:-10}
      
      # Feature toggles
      - CLIPS_ENABLED=${CLIPS_ENABLED:-true}
      - LIVE_ALERTS_ENABLED=${LIVE_ALERTS_ENABLED:-true}
      - VOICE_MANAGER_ENABLED=${VOICE_MANAGER_ENABLED:-true}
      
      # Timezone
      - TZ=${TZ:-America/Toronto}
    volumes:
      - ./data:/data
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    networks:
      - homelab
    # No ports needed - bot connects outbound to Discord/Twitch

networks:
  homelab:
    name: homelab
    external: true
