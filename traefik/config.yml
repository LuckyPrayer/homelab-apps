# Traefik - Reverse Proxy
# Provides HTTPS termination and routing for all services
#
# Secrets required:
#   - CF_DNS_API_TOKEN: Cloudflare DNS API token for ACME challenges
#
# Config files needed:
#   - config/acme.json: Let's Encrypt certificate storage (auto-created)
#   - config/dynamic.yml: Dynamic routing configuration

name: traefik
description: Reverse proxy with automatic HTTPS via Cloudflare DNS
image: traefik:2.11

# Secrets from Infisical
secrets:
  infisical_path: /infrastructure/dns/cloudflare

# Environment defaults
environment:
  TRAEFIK_EMAIL: admin@thebozic.com

# Backup configuration
backup:
  enabled: true
  paths:
    - config/acme.json
  stop_during_backup: false  # NEVER stop traefik
  exclude:
    - "*.log"

# Restore configuration
restore:
  enabled: true
  priority: 1                 # Restore FIRST - all apps depend on it
  pre_restore: null
  post_restore: |
    # acme.json must have strict permissions
    chmod 600 config/acme.json 2>/dev/null || true

# CRITICAL: Never stop this service during backup
hot_backup: true

dependencies: []

tags:
  - infrastructure
  - critical
  - networking
