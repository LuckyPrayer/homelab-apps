# Uptime Kuma - Status Monitoring
# A self-hosted monitoring tool like "Uptime Robot"
#
# Deployed via Ansible to pharos (AWS cloud host)
# Purpose: External monitoring of homelab services from outside the network
# Docs: https://github.com/louislam/uptime-kuma

services:
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/Toronto}
      # Run as non-root for security
      - PUID=1000
      - PGID=1000
    volumes:
      - ./data:/app/data
    ports:
      - "${UPTIME_KUMA_PORT:-3001}:3001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW  # Required for ping monitoring
      - CHOWN    # Required for data directory ownership on startup
      - SETUID   # Required for startup user switching
      - SETGID   # Required for startup user switching
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime-kuma.rule=Host(`status.${ENV:-dev}.${BASE_DOMAIN:-thebozic.com}`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls.certresolver=mytls"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"
    healthcheck:
      test: ["CMD", "node", "/app/extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  default:
    name: homelab-network
    external: true
