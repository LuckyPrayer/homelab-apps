version: "3.9"

# Vaultwarden - Password Manager
# A Bitwarden-compatible server
#
# Deployed via Komodo Git integration
# Secrets: VAULTWARDEN_ADMIN_TOKEN (required), SMTP credentials (optional)
# Infisical path: /services/vaultwarden/
# Docs: https://github.com/dani-garcia/vaultwarden/wiki

services:
  vaultwarden:
    image: vaultwarden/server:1.32.7-alpine
    container_name: vaultwarden
    user: "3002:3002"  # Run as docker-svc user
    environment:
      # Domain configuration
      - DOMAIN=https://vaultwarden.${ENV:-dev}.${BASE_DOMAIN:-thebozic.com}
      
      # Security settings
      - SIGNUPS_ALLOWED=${SIGNUPS_ALLOWED:-false}
      - INVITATIONS_ALLOWED=${INVITATIONS_ALLOWED:-true}
      - SHOW_PASSWORD_HINT=${SHOW_PASSWORD_HINT:-false}
      
      # Admin token (from Infisical: /services/vaultwarden/VAULTWARDEN_ADMIN_TOKEN)
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      
      # Server settings
      - WEBSOCKET_ENABLED=true
      - ROCKET_PORT=8080
      - TZ=${TZ:-America/Toronto}
    volumes:
      - ./data:/data
    ports:
      - "8200:8080"
      - "3012:3012"  # WebSocket port
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "traefik.enable=true"
      # Main web interface
      - traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.${ENV:-dev}.${BASE_DOMAIN:-thebozic.com}`)
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls.certresolver=mytls"
      - "traefik.http.routers.vaultwarden.service=vaultwarden"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=8080"
      # WebSocket support for live sync
      - traefik.http.routers.vaultwarden-ws.rule=Host(`vaultwarden.${ENV:-dev}.${BASE_DOMAIN:-thebozic.com}`) && Path(`/notifications/hub`)
      - "traefik.http.routers.vaultwarden-ws.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-ws.tls.certresolver=mytls"
      - "traefik.http.routers.vaultwarden-ws.service=vaultwarden-ws"
      - "traefik.http.services.vaultwarden-ws.loadbalancer.server.port=3012"
    restart: unless-stopped
    networks:
      - homelab

networks:
  homelab:
    name: homelab
    external: true
